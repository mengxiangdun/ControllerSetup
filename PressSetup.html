<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kaanh Intelligence</title>
    <link rel='stylesheet' href='./style.css' />
    <script src="external/jquery/jquery.js"></script>
    <script src="jquery-ui.js"></script>
    <script src="echarts.js"></script>
    <title>Servo Press Monitor</title>
    <link href="jquery-ui.css" rel="stylesheet">
    <link href="/jquery-ui.css" rel="stylesheet">
</head>
<body>
<p>Welcome to Kaanh Intelligence</p>
<input id="serverIP" placeholder="Enter server ip"/>
<button id="getXml" >Get Configuration</button>
<button id="saveXml">Save & Run</button>

<table id="InputTable_Temp" border="1" style="width: 600px">
    <tr bgcolor="#ffe4c4">
        <td style="width: 40%">Attribute Name</td>
        <td style="width: 20%">Value</td>
    </tr>
</table>


<script src="/socket.io/socket.io.js"></script>
<script>

    $("#InputTable_Temp").hide();
    var xmlDoc;
    var setupList=[];
    var serverIP="ws://127.0.0.1:5866";

    var SetupElement=function (attribute_name,node_name,parent_node_name) {

        this.attribute_name=attribute_name;
        this.node_name=node_name;
        this.parent_node_name=parent_node_name;


    }

    function GetSetupList() {
        setupList[setupList.length]=new SetupElement("type","sm","sm_pool");
        setupList[setupList.length]=new SetupElement("type","index_1600","sm");

    }

    GetSetupList();

    document.getElementById("serverIP").onchange=function(){
        var str=document.getElementById("serverIP").value;
        if (str!=""&&str!=null){
            serverIP="ws://"+str+":5866";
            console.log(serverIP);
        }
    }

    document.getElementById("getXml").onclick=function(){
        $("#InputTable_Temp").show();
        SendCmd("2&1&0&0&0&GetXml --check_none");
    }

    var input_id=0;

    function printNodeName(node, name) {
        if (node.nodeType == 1){
            // console.log(node.nodeName);
            name+=node.nodeName+":";
            for (var i=0;i<setupList.length;i++){
                if (node.nodeName==setupList[i].node_name && node.parentNode.nodeName==setupList[i].parent_node_name){
                    // console.log("node ok "+node.nodeName);
                    if (node.getElementsByTagName(setupList[i].attribute_name)!=null){
                        // console.log("attribute ok "+setupList[i].attribute_name+node.getAttribute(setupList[i].attribute_name));
                        var attri_value=node.getAttribute(setupList[i].attribute_name);
                        var ui_id="input_"+(input_id++).toString();

                        //生成UI并赋值
                        // var processName=name+":"+setupList[i].parent_node_name+":"+setupList[i].node_name+":"+setupList[i].attribute_name;
                        var processName=name+":"+setupList[i].attribute_name;
                        var tr="<tr><td>"+processName+"</td><td><input value="+attri_value+" id='"+ui_id+"'/></td></tr>"
                        //console.log(tr);
                        $("#InputTable_Temp").append(tr);
                    }
                }
            }
        if (node.hasChildNodes()) {
            var sonNodes = node.childNodes;
            for (var j = 0; j < sonNodes.length; j++) {
                if (sonNodes[j].nodeType == 1) {
                    printNodeName(sonNodes[j],name);
                }
            }
        }
    }
    }

    function CollectNodeName(node, name) {
        if (node.nodeType == 1){
            // console.log(node.nodeName);
            name+=node.nodeName+":";
            for (var i=0;i<setupList.length;i++){
                if (node.nodeName==setupList[i].node_name && node.parentNode.nodeName==setupList[i].parent_node_name){
                    console.log("node ok "+node.nodeName);
                    if (node.getElementsByTagName(setupList[i].attribute_name)!=null){
                        // console.log("attribute ok "+setupList[i].attribute_name+node.getAttribute(setupList[i].attribute_name));
                        //var attri_value=node.getAttribute(setupList[i].attribute_name);
                        var ui_id="input_"+(input_id++).toString();

                        var attri_value=$("#"+ui_id).val();
                        console.log("##"+$("#"+ui_id).val());

                        console.log("text:"+$("#input_1").text());
                        console.log("##"+$("#input_1").val());
                        console.log(ui_id+":"+ attri_value);
                        node.setAttribute(setupList[i].attribute_name,attri_value);

                        //生成UI并赋值
                        // var processName=name+":"+setupList[i].parent_node_name+":"+setupList[i].node_name+":"+setupList[i].attribute_name;
                        // var processName=name+":"+setupList[i].attribute_name;
                        // var tr="<tr><td>"+processName+"</td><td><input value="+attri_value+" id='"+ui_id[0]+"'/></td></tr>"
                        // //console.log(tr);
                        // $("#InputTable_Temp").append(tr);
                    }
                }
            }
            if (node.hasChildNodes()) {
                var sonNodes = node.childNodes;
                for (var j = 0; j < sonNodes.length; j++) {
                    if (sonNodes[j].nodeType == 1) {
                        CollectNodeName(sonNodes[j],name);
                    }
                }
            }
        }
    }

    function GetXmlDoc(data){
        //
        console.log(data);
        var parser=new DOMParser();
        xmlDoc=parser.parseFromString(data,"text/xml");
        //TraverseNodes(xmlDoc.documentElement);
        printNodeName(xmlDoc.documentElement,"");
        var x=xmlDoc.documentElement.childNodes;
        console.log(x.length);

    }

    document.getElementById("saveXml").onclick= function() {

        // for (var i=0;i<setupList.length;i++){
        //     var CH_list=xmlDoc.getElementsByTagName("CmdList");
        //     var para_value=[];
        //     var ui_id=[];
        //     for (var j=0;j<CH_list.length;j++){
        //         //获得UI值
        //         ui_id[j]="ch"+(j+1).toString()+"_"+setupList[i].cmdNum+"_"+setupList[i].cmdName+"_"+setupList[i].paraName;
        //         console.log(ui_id[j]);
        //
        //         para_value[j]=$("#"+ui_id[j]).val();
        //         console.log(para_value[j]);
        //
        //
        //         var cmdList=CH_list[j].getElementsByTagName("cmd");
        //         //获得命令
        //         var cmd_toSet=cmdList[setupList[i].cmdNum-1].childNodes[0].nodeValue;
        //         //解析命令并赋值新参数
        //         var cmd_toSet_new="";
        //
        //         var cmd_paraList=cmd_toSet.split(" ");
        //         for (var k = 0; k < cmd_paraList.length;k++){
        //             if (cmd_paraList[k].indexOf("--"+setupList[i].paraName+"=")>-1 || cmd_paraList[k].indexOf("-"+setupList[i].paraName_abra+"=")>-1){
        //                 //para_value[j]=cmd_paraList[k].split("=")[1];
        //                 var newParaStr=cmd_paraList[k].split("=")[0]+"="+para_value[j];
        //                 cmd_paraList[k]=newParaStr;
        //             }
        //             cmd_toSet_new+=cmd_paraList[k]+" ";
        //         }
        //         cmdList[setupList[i].cmdNum-1].childNodes[0].nodeValue=cmd_toSet_new;
        //         console.log(cmd_toSet_new);
        //     }
        // }

        input_id=0;
        CollectNodeName(xmlDoc.documentElement,"");
        var text = (new XMLSerializer()).serializeToString(xmlDoc);
        console.log(text);
        SendCmd("3&1&0&0&0&"+text);

        // ws.close();
        // var url="PressMonitor.html?ServerIp="+escape( serverIP);
        // location.href=url;

    }

</script>


<script type="text/javascript">

    var ws;

    function PackBotCmd(str) {
        //1&1&0&0&0&Read --check_none
        var strArray=str.split("&");
        if (strArray.length>3){
            var cmd_id=parseInt(strArray[0]);
            var cmd_option=parseInt((strArray[1]));
            var res_1=parseInt((strArray[2]));
            var res_2=parseInt((strArray[3]));
            var res_3=parseInt((strArray[4]));
            //var byte_cmd=stringToByte(strArray[5]);
            var mes_length=strArray[5].length;
            var buffer=new ArrayBuffer(40+mes_length);
            var headView=new DataView(buffer);
            // var mesView=new Uint16Array(buffer,40,mes_length*2);
            // for (var i = 0, strLen = strArray[5].length; i < strLen; i++) {
            //     mesView[i] = strArray[5].charCodeAt(i);
            // }
            headView.setInt32(0,mes_length,true);
            headView.setInt32(4,cmd_id,true);
            headView.setInt32(8,cmd_option,true);
            headView.setInt32(16,res_1,true);
            headView.setInt32(24,res_2,true);
            headView.setInt32(32,res_3,true);
            for (var i=0;i<mes_length;i++){
                headView.setUint8(40+i,strArray[5].charCodeAt(i));
            }
            // console.log(headView.buffer.byteLength);
            // var getMess=String.fromCharCode.apply(null,new Uint8Array(headView.buffer,40));
            // console.log(getMess);

            ws.send(headView.buffer);
            console.log("send cmd"+headView.buffer.byteLength);

        }
    }

    function AnalizeBotData(buffer) {
        var dataView=new DataView(buffer);
        var cmd_length=dataView.getInt32(0);
        console.log("cmd_length"+cmd_length);
        var cmd_id=dataView.getInt32(4,true);
        console.log("cmd_id"+cmd_id);
        var getMess;
        //getMess=String.fromCharCode.apply(null,new Uint16Array(buffer));
        //console.log(getMess);
        //return string message
        if (cmd_id==2){
            //console.log(buffer.toString());
            getMess=String.fromCharCode.apply(null,new Uint8Array(buffer,40));
            //console.log(getMess.length);
            console.log(getMess);
            GetXmlDoc(getMess);
            //return getMess;
        }
        //return float message
        if (cmd_id=0){
            var step=new Array();
            for(var i=0;i<(dataView.length-40)/8;i++){
                step[i]=dataView.getFloat64(432+i*8);
            }
            //return step;
        }
    }

    function buildWS() {
        ws=new WebSocket(serverIP);
        //  ws=new WebSocket("ws://10.10.10.126:5866");
        // ws=new WebSocket("ws://120.27.231.59:8001");
        ws.onopen=function (evt) {
            console.log("Connection open...");
            // ws.send("Hello");

        }
        ws.onmessage=function (evt) {
            // receiveStr=evt.data;
            // console.log(receiveStr);
            if (typeof evt.data=== String){
                console.log("Received "+evt.data);
                receiveStr=evt.data;
            }
            if (evt.data instanceof ArrayBuffer){
                console.log("receive byte"+evt.data.byteLength);
                AnalizeBotData(evt.data);
            }


        }
        ws.onclose=function (evt) {
            console.log("closed");

        }
    }

    buildWS();

    function SendCmd(cmd){
        switch (ws.readyState) {
            case WebSocket.CONNECTING:
                break;
            case WebSocket.OPEN:
                ws.binaryType='arraybuffer';
                PackBotCmd(cmd);
                //ws.send(PackBotCmd("1&1&0&0&0&Read --check_none"));
                //ws.send("hello");
                //CheckData(receiveStr);
                break;
            case  WebSocket.CLOSING:
                break;
            case WebSocket.CLOSED:
                buildWS();
                break;
        }
    }

</script>


<script type="text/javascript">
    $("#getXml").button();
    $("#saveXml").button();
    $("#run").button();
    $( "#accordion" ).accordion({
        heightStyle:"content",
        collapsible: "true"

    });

</script>
</body>
</html>
